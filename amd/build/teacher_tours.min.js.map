{"version":3,"file":"teacher_tours.min.js","sources":["../src/teacher_tours.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n/**\n * JavaScript for handling tour creation via button click.\n *\n * @module block_teacher_tours/teacher_tours\n * @copyright 2025 Your Name <your.email@example.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/str',\n    'tool_usertours/events',\n    'tool_usertours/repository',\n    'core/templates',\n    'tool_usertours/tour'\n], function($, Ajax, Str, UserTourEvents, tourRepository, Templates, BootstrapTour) {\n\n        // JSON object that holds the information for the tour that is being sent to an endpoint when the teacher hits save\n        let tourObject = {\n            steps: [\n                /*\n                template step object\n                {\n                    title: '',\n                    content: '',\n                    targettype: '2',\n                    targetvalue: '',\n                    placement: '',\n                    orphan: 'true',\n                    backdrop: '',\n                    reflex: 'false',\n                    config: '',\n                } */\n            ],\n            name: '',\n            description: '',\n            pathmatch: '',\n            enabled: '',\n            filter_values: '',\n            sortorder: '',\n        };\n\n        let stickyTarget = null;\n        let sticky = false;\n\n        let currentStepObject = {};\n\n        // Tour queue state for consecutive tour triggering\n        let tourQueue = [];           // Array of {id, type, name, sortorder, placementid}\n        let currentTourIndex = 0;     // Index of current/next tour in queue\n        let shownTourIds = [];        // Array of tour keys already shown (e.g., 'standard_123', 'custom_456')\n        let currentCourseId = null;   // Store course ID for queue operations\n        let tourEndedListenerAdded = false; // Flag to prevent duplicate listeners\n        let manualTourInProgress = false; // Flag to prevent queue auto-start during manual tour\n\n        // Init the tourobject and starts the editor\n        const init = function (courseid, customTours) {\n            currentCourseId = courseid;\n            init_styles();\n            initializeEventBindings();\n            Object.values(customTours).forEach(tour => {\n                // Only show placement buttons for enabled tours\n                if (tour.enabled) {\n                    setPlacements(tour.placementid, tour.id);\n                }\n            });\n            resetTourObject(courseid);\n\n            // Initialize consecutive tour system\n            initTourQueue(courseid);\n            setupTourEndedListener();\n        };\n\n        /**\n         * Initialize the tour queue by fetching pending tours from the server.\n         *\n         * @param {number} courseid - The course ID\n         */\n        const initTourQueue = function (courseid) {\n            Ajax.call([{\n                methodname: 'block_teacher_tours_get_pending_tours',\n                args: {\n                    courseid: courseid,\n                    shownids: JSON.stringify(shownTourIds)\n                }\n            }])[0].done(function (tours) {\n                tourQueue = tours;\n                currentTourIndex = 0;\n            }).fail(function (error) {\n                window.console.error('Teacher Tours: Failed to fetch pending tours', error);\n                tourQueue = [];\n            });\n        };\n\n        /**\n         * Setup the tour ended event listener for consecutive tour triggering.\n         */\n        const setupTourEndedListener = function () {\n            if (tourEndedListenerAdded) {\n                return;\n            }\n            tourEndedListenerAdded = true;\n\n            document.addEventListener(UserTourEvents.eventTypes.tourEnded, handleTourEnded);\n        };\n\n        /**\n         * Handle the tour ended event - start the next tour if available.\n         *\n         * @param {Event} e - The tour ended event\n         */\n        const handleTourEnded = function (e) {\n            // Get the tour that just ended\n            const endedTour = e.detail?.tour;\n\n            if (endedTour) {\n                // Mark the ended tour as shown\n                const endedTourId = endedTour.tourId || endedTour.id;\n                if (endedTourId) {\n                    // Check if this was a standard or custom tour\n                    const config = endedTour.originalConfig || {};\n                    if (config.custom_tour_id) {\n                        shownTourIds.push('custom_' + config.custom_tour_id);\n                    } else {\n                        shownTourIds.push('standard_' + endedTourId);\n                    }\n                }\n            }\n\n            // If this was a manually triggered tour, don't auto-start the next one\n            if (manualTourInProgress) {\n                manualTourInProgress = false;\n                return;\n            }\n\n            // Small delay to let UI settle before starting next tour\n            setTimeout(function () {\n                startNextTour();\n            }, 500);\n        };\n\n        /**\n         * Start the next tour in the queue.\n         */\n        const startNextTour = function () {\n            // Find the next tour that hasn't been shown\n            while (currentTourIndex < tourQueue.length) {\n                const nextTour = tourQueue[currentTourIndex];\n                const tourKey = nextTour.type + '_' + nextTour.id;\n\n                currentTourIndex++;\n\n                // Skip if already shown\n                if (shownTourIds.includes(tourKey)) {\n                    continue;\n                }\n\n                // Mark as shown\n                shownTourIds.push(tourKey);\n\n                if (nextTour.type === 'custom') {\n                    // Start custom tour via our API\n                    startCustomTourFromQueue(nextTour.id);\n                } else {\n                    // Start standard tour using Moodle's tour repository\n                    startStandardTourFromQueue(nextTour.id);\n                }\n                return;\n            }\n\n            // No more tours - refresh the queue for next time\n            if (currentCourseId) {\n                initTourQueue(currentCourseId);\n            }\n        };\n\n        /**\n         * Start a standard tour from the queue.\n         *\n         * @param {number} tourId - The tour ID\n         */\n        const startStandardTourFromQueue = function (tourId) {\n            // Fetch the tour configuration and start it\n            tourRepository.fetchTour(tourId)\n                .then(function (response) {\n                    if (response && response.hasOwnProperty('tourconfig')) {\n                        return Templates.renderForPromise('tool_usertours/tourstep', response.tourconfig)\n                            .then(function (result) {\n                                startTourWithConfig(tourId, result.html, response.tourconfig);\n                                return;\n                            });\n                    }\n                    // No tour config, try next tour\n                    window.console.warn('Teacher Tours: No tour config in response, trying next tour');\n                    startNextTour();\n                    return;\n                })\n                .catch(function (error) {\n                    // If this tour fails, try the next one\n                    window.console.error('Teacher Tours: Error fetching/starting tour:', error);\n                    startNextTour();\n                });\n        };\n\n        /**\n         * Start a tour with the given configuration.\n         *\n         * @param {number} tourId - The tour ID\n         * @param {string} template - The rendered template HTML\n         * @param {object} tourConfig - The tour configuration\n         */\n        const startTourWithConfig = function (tourId, template, tourConfig) {\n            // Sort out the tour name\n            tourConfig.tourName = tourConfig.name;\n            delete tourConfig.name;\n\n            // Add the template to the configuration\n            tourConfig.template = template;\n\n            // Process steps\n            tourConfig.steps = tourConfig.steps.map(function (step) {\n                if (typeof step.element !== 'undefined') {\n                    step.target = step.element;\n                    delete step.element;\n                }\n\n                if (typeof step.reflex !== 'undefined') {\n                    step.moveOnClick = !!step.reflex;\n                    delete step.reflex;\n                }\n\n                if (typeof step.content !== 'undefined') {\n                    step.body = step.content;\n                    delete step.content;\n                }\n\n                return step;\n            });\n\n            // Create and start the tour\n            const tour = new BootstrapTour(tourConfig);\n            tour.startTour(0);\n        };\n\n        /**\n         * Start a custom tour from the queue.\n         *\n         * @param {number} customTourId - The custom tour ID\n         */\n        const startCustomTourFromQueue = function (customTourId) {\n            Ajax.call([{\n                methodname: 'block_teacher_tours_start_custom_tour',\n                args: { customtourid: customTourId }\n            }])[0].done(function (response) {\n                if (response.success && response.tourid) {\n                    // Fetch and start the newly created core tour\n                    startStandardTourFromQueue(response.tourid);\n                } else {\n                    // If creation failed, try the next tour\n                    window.console.warn('Teacher Tours: Failed to start custom tour', response.message);\n                    startNextTour();\n                }\n            }).fail(function (error) {\n                window.console.error('Teacher Tours: AJAX error starting custom tour', error);\n                // If AJAX fails, try the next tour\n                startNextTour();\n            });\n        };\n\n        // Starts the picker at first\n        const startEditor = function () {\n            // Hide the create new tour button when editing\n            $('#start-tour-creation').hide();\n            $('#start-sticky-creation').hide();\n            $('#step-creation').hide();\n            // Show the tour editor interface\n            $('#tour-editor').show();\n            if (sticky) {\n                highlightPlacements();\n            } else {\n                highlightElements();\n            }\n        };\n\n        // Show current step indicator\n        const showCurrentStepIndicator = function (elementText) {\n            $('#current-step-element').text(elementText);\n            $('#current-step-indicator').show();\n        };\n\n        // Show current step indicator\n        const showTourStepsPreview = function () {\n            $('.tour-preview').html('');\n            tourObject.steps.forEach((step, index) => {\n                $('.tour-preview')\n                    .append('<div class=\"tour-step-preview\" data-step-index=\"' + index + '\">Step ' + (index + 1) +\n                        ' <strong> ' + step.targetvalue + ':</strong> ' + step.title +\n                        ' <i class=\"fa fa-pencil edit-step-icon\" style=\"float: right; cursor: pointer; margin-left: 10px;\">' +\n                        '</i></div>');\n            });\n            $('.tour-preview').show();\n        };\n\n        // Hide current step indicator\n        const hideCurrentStepIndicator = function () {\n            $('#current-step-indicator').hide();\n        };\n\n        const resetCurrentStepObject = function () {\n            currentStepObject = {};\n        };\n\n        // Handle tour toggle switches\n        const handleTourToggle = function (tourId, enabled, tourType) {\n            // Determine which endpoint to call based on tour type\n            const methodname = tourType === 'custom'\n                ? 'block_teacher_tours_toggle_custom_tour_enabled'\n                : 'block_teacher_tours_toggle_tour_enabled';\n\n            // Make AJAX call to backend to save the state\n            Ajax.call([{\n                methodname: methodname,\n                args: { tourid: tourId, enabled: enabled }\n            }])[0].done(function (response) {\n                if (response.success) {\n                    // Update the UI based on the actual state from server.\n                    const tourCard = $(`[data-tour-id=\"${tourId}\"][data-tour-type=\"${tourType}\"]`);\n                    const statusElement = tourCard.find('.tour-status');\n\n                    if (response.enabled) {\n                        Str.get_string('enabled', 'block_teacher_tours')\n                            .then(function (enabledText) {\n                                statusElement.html('<i class=\"fa fa-check-circle text-success\"></i> ' + enabledText);\n                            });\n                        tourCard.find('.tour-toggle').prop('checked', true);\n                    } else {\n                        Str.get_string('disabled', 'block_teacher_tours')\n                            .then(function (disabledText) {\n                                statusElement.html('<i class=\"fa fa-times-circle text-muted\"></i> ' + disabledText);\n                            });\n                        tourCard.find('.tour-toggle').prop('checked', false);\n                    }\n                } else {\n                    // Revert the toggle if the operation failed\n                    const tourCard = $(`[data-tour-id=\"${tourId}\"][data-tour-type=\"${tourType}\"]`);\n                    tourCard.find('.tour-toggle').prop('checked', !enabled);\n                    alert('Failed to update tour status. Please try again.');\n                }\n            }).fail(function () {\n                // Revert the toggle on error\n                const tourCard = $(`[data-tour-id=\"${tourId}\"][data-tour-type=\"${tourType}\"]`);\n                tourCard.find('.tour-toggle').prop('checked', !enabled);\n                alert('Error updating tour status. Please try again.');\n            });\n        };\n\n        // Handle tour editing\n        const handleTourEdit = function (tourId, tourType) {\n            // TODO: Should open the form in the backend to edit the tour\n            const tourTypeLabel = tourType === 'custom' ? 'Custom' : 'Standard';\n            alert('Edit functionality will be implemented when backend is ready. ' + tourTypeLabel + ' Tour ID: ' + tourId);\n        };\n\n        // Handle tour deletion\n        const handleTourDelete = function (tourId, tourType) {\n            if (confirm('Are you sure you want to delete this tour? This action cannot be undone.')) {\n                // Determine which endpoint to call based on tour type\n                const methodname = tourType === 'custom'\n                    ? 'block_teacher_tours_delete_custom_tour'\n                    : 'block_teacher_tours_delete_tour';\n\n                // Make AJAX call to backend to delete the tour\n                Ajax.call([{\n                    methodname: methodname,\n                    args: { tourid: tourId }\n                }])[0].done(function (response) {\n                    if (response.success) {\n                        // Remove the card from UI with animation\n                        $(`[data-tour-id=\"${tourId}\"][data-tour-type=\"${tourType}\"]`).fadeOut(300, function () {\n                            $(this).remove();\n                            // Check if no standard tours left\n                            if ($('.existing-tours .tour-card').length === 0) {\n                                $('.existing-tours').hide();\n                            }\n                            // Check if no custom tours left\n                            if ($('.existing-custom-tours .tour-card').length === 0) {\n                                $('.existing-custom-tours').hide();\n                            }\n                        });\n                    } else {\n                        alert('Failed to delete tour. Please try again.');\n                    }\n                }).fail(function () {\n                    alert('Error deleting tour. Please try again.');\n                });\n            }\n        };\n\n        // Initialise style class for highlights\n        const hexToRgba = function (hex, opacity) {\n            // Remove '#' if present\n            hex = hex.replace(/^#/, '');\n\n            // Parse r, g, b values\n            let r = parseInt(hex.substring(0, 2), 16);\n            let g = parseInt(hex.substring(2, 4), 16);\n            let b = parseInt(hex.substring(4, 6), 16);\n\n            return `rgba(${r}, ${g}, ${b}, ${opacity})`;\n        };\n\n        const init_styles = function () {\n            const colors = window.teachertoursColors;\n            const style = document.createElement('style');\n\n            const moduleHighlightopacity03 = hexToRgba(colors.moduleHighlight, 0.3);\n            const moduleHighlightopacity05 = hexToRgba(colors.moduleHighlight, 0.5);\n\n            const sectionHighlightopacity03 = hexToRgba(colors.sectionHighlight, 0.3);\n            const sectionHighlightopacity05 = hexToRgba(colors.sectionHighlight, 0.5);\n\n            style.textContent = `\n                /* Tour creation highlighting */\n                .module-highlight {\n                    background-color: ${moduleHighlightopacity03};\n                    border: 1px solid ${colors.moduleHighlight};\n                    cursor: pointer;\n                    transition: all 0.3s ease;\n                    border-radius: 1rem;\n                }\n                .module-highlight:hover {\n                    background-color: ${moduleHighlightopacity05};\n                    transform: scale(1.02);\n                }\n                .section-highlight {\n                    background-color: ${sectionHighlightopacity03};\n                    border: 1px solid ${colors.sectionHighlight};\n                    cursor: pointer;\n                    transition: all 0.3s ease;\n                    border-radius: 1rem;\n                }\n\n                .section-highlight:hover {\n                    background-color: ${sectionHighlightopacity05};\n                    transform: scale(1.02);\n                }\n\n                /* Tour Preview Styling */\n                .tour-preview {\n                    margin-bottom: 20px;\n                    background-color: #fff;\n                }\n\n                .tour-step-preview {\n                    display: flex;\n                    align-items: center;\n                    padding: 10px 15px;\n                    margin-bottom: 8px;\n                    background-color: #f8f9fa;\n                    border: 1px solid #e9ecef;\n                    border-radius: 6px;\n                    border-left: 4px solid ${colors.moduleHighlight};\n                    font-size: 14px;\n                    transition: all 0.2s ease;\n                }\n\n                .tour-step-preview:hover {\n                    background-color: #e9ecef;\n                    transform: translateX(2px);\n                }\n\n                .tour-step-preview:last-child {\n                    margin-bottom: 0;\n                }\n\n                .tour-step-preview strong {\n                    color: #495057;\n                    margin-right: 8px;\n                }\n\n                .tour-step-preview .edit-step-icon {\n                    color: #6c757d;\n                    transition: color 0.2s;\n                    margin-left: auto;\n                }\n\n                    .tour-step-preview .edit-step-icon:hover {\n                    color: #007bff;\n                    cursor: pointer;\n                }\n\n                /* Instructions Styling */\n                .editor-instructions {\n                    background-color: #e7f3ff;\n                    border: 1px solid #b8daff;\n                    border-radius: 6px;\n                    padding: 12px 16px;\n                    margin-bottom: 20px;\n                    color: ${colors.moduleHighlight};\n                    font-size: 14px;\n                    display: flex;\n                    align-items: center;\n                }\n\n                .editor-instructions::before {\n                    content: \"ðŸ’¡\";\n                    margin-right: 10px;\n                    font-size: 16px;\n                }\n\n                /* Current Step Indicator */\n                .current-step-indicator .alert {\n                    margin-bottom: 15px;\n                    border-left: 4px solid #17a2b8;\n                }\n\n                /* Add Step Button Container */\n                .add-step-container {\n                    text-align: center;\n                    padding: 20px;\n                    border: 2px dashed #dee2e6;\n                    border-radius: 8px;\n                    background-color: #f8f9fa;\n                    margin-top: 15px;\n                }\n\n                .add-step-container:hover {\n                    border-color: ${colors.moduleHighlight};\n                    background-color: #e7f3ff;\n                }\n\n                /* Text Editor Styling */\n                .text-editor {\n                    margin-top: 20px;\n                    padding: 20px;\n                    border: 1px solid #dee2e6;\n                    border-radius: 8px;\n                    background-color: white;\n                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n                }\n\n                .text-editor-header {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    margin-bottom: 20px;\n                    padding-bottom: 15px;\n                    border-bottom: 1px solid #dee2e6;\n                }\n\n                /* Tour Cards Styling */\n                .tour-list {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 15px;\n                    margin-bottom: 20px;\n                }\n\n                .tour-card {\n                    background: white;\n                    border: 1px solid #dee2e6;\n                    border-radius: 8px;\n                    padding: 16px;\n                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n                    transition: all 0.2s ease;\n                }\n\n                .tour-card:hover {\n                    border-color: ${colors.moduleHighlight};\n                    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.15);\n                    transform: translateY(-1px);\n                }\n\n                .tour-card-header {\n                    margin-bottom: 12px;\n                }\n\n                .tour-info {\n                    flex: 1;\n                    margin-right: 20px;\n                }\n\n                .tour-name {\n                    font-size: 16px;\n                    font-weight: 600;\n                    color: #343a40;\n                    margin: 0 0 8px 0;\n                    line-height: 1.3;\n                }\n\n                .tour-description {\n                    color: #6c757d;\n                    font-size: 14px;\n                    margin: 0;\n                    line-height: 1.4;\n                    max-width: 400px;\n                }\n\n                .tour-controls {\n                    display: flex;\n                    justify-content: space-between;\n                    flex-shrink: 0;\n                }\n\n                .form-switch {\n                padding-top: .25rem;\n                    margin-bottom: 0;\n                }\n\n                .form-switch .form-check-input {\n                    width: 2.5em;\n                    height: 1.25em;\n                }\n\n                .form-switch .form-check-label {\n                    font-size: 13px;\n                    margin-left: 10px;\n                    color: #6c757d;\n                }\n\n                .tour-toggle:checked+.form-check-label .enabled-text {\n                }\n\n                .tour-toggle:not(:checked)+.form-check-label .enabled-text {\n                    display: none;\n                }\n\n                .tour-toggle:checked+.form-check-label .disabled-text {\n                    display: none;\n                }\n\n                .tour-card-footer {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    border-top: 1px solid #f8f9fa;\n                }\n\n                .tour-status {\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    font-size: 13px;\n                }\n                \n                .tour-actions {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 12px;\n                }\n\n                /* Empty state for no tours */\n                .existing-tours:empty::before {\n                    content: \"No tours created yet. Click 'Create New Tour' to get started.\";\n                    display: block;\n                    text-align: center;\n                    color: #6c757d;\n                    font-style: italic;\n                    padding: 40px 20px;\n                    background: #f8f9fa;\n                    border-radius: 8px;\n                    border: 2px dashed #dee2e6;\n                }\n\n                /* Custom tour card styling */\n                .existing-custom-tours {\n                    margin-top: 20px;\n                }\n\n                .existing-custom-tours h5 {\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                }\n\n                .tour-card-custom {\n                    border-left: 4px solid #17a2b8 !important;\n                    background: linear-gradient(to right, rgba(23, 162, 184, 0.05), white);\n                }\n\n                .tour-card-custom:hover {\n                    border-left-color: #138496 !important;\n                }\n\n                .tour-card-custom .badge {\n                    font-size: 11px;\n                    font-weight: 500;\n                    padding: 3px 8px;\n                }\n\n                .tour-card-custom .badge i {\n                    margin-right: 3px;\n                }\n\n                .btn.btn-sm.btn-outline-primary.section-sticky-highlight {\n                    border-style: dashed;\n                    position: absolute;\n                    top: -0.5rem;\n                    right: -0.5rem;\n                    background: white;\n                }\n\n                .btn.btn-sm.btn-outline-primary.section-sticky-highlight:hover {\n                    color: inherit;\n                }\n \n                .btn.btn-sm.btn-outline-primary.section-sticky-button {\n                    border-style: solid;\n                    position: absolute;\n                    top: -0.5rem;\n                    right: -0.5rem;\n                    background: white;\n                }\n \n                .btn.btn-sm.btn-outline-primary.section-sticky-button:hover {\n                    color: inherit;\n                }\n\n                .btn.btn-sm.btn-outline-primary.section-sticky-button-temp {\n                    border-style: solid;\n                    position: absolute;\n                    top: -0.5rem;\n                    right: -0.5rem;\n                    background: white;\n                }\n \n                .btn.btn-sm.btn-outline-primary.section-sticky-button-temp:hover {\n                    color: inherit;\n                }\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-highlight {\n                    border-style: dashed;\n                    position: absolute;\n                    top: 0;\n                    right: 0;\n                    background: white;\n                }\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-button {\n                    border-style: solid;\n                    position: absolute;\n                    top: 0;\n                    right: 0;\n                    background: white;\n                }\n\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-button-temp {\n                    border-style: solid;\n                    position: absolute;\n                    top: 0;\n                    right: 0;\n                    background: white;\n                }\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-highlight:hover {\n                    color: inherit;\n                }\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-button:hover {\n                    color: inherit;\n                }\n \n                .btn.btn-sm.btn-outline-primary.header-sticky-button-temp:hover {\n                    color: inherit;\n                }\n            `;\n\n            document.head.appendChild(style);\n        };\n\n        // Store event handlers for specific removal\n        const tourEventHandlers = {\n            stickySelectClick: function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                const element = e.currentTarget;\n                addStickyButton(element);\n                let parent = element.parentElement;\n                stickyTarget = parent.getAttribute('id');\n\n                removeHighlighting();\n                sticky = false;\n                highlightElements();\n            },\n            stickyStartClick: function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                const element = e.currentTarget;\n                let customtourid = element.dataset.customtourid;\n\n                // Mark this as a manual tour to prevent queue auto-start\n                manualTourInProgress = true;\n\n                // Get custom tour config by its ID (no core table records created)\n                Ajax.call([{\n                    methodname: 'block_teacher_tours_start_custom_tour',\n                    args: { customtourid: parseInt(customtourid, 10) },\n                }])[0].then(function (response) {\n                    if (response.success && response.tourconfig) {\n                        // Parse the tour config and start it directly\n                        const tourConfig = JSON.parse(response.tourconfig);\n\n                        // Render the tour template and start\n                        return Templates.renderForPromise('tool_usertours/tourstep', tourConfig)\n                            .then(function (result) {\n                                tourConfig.template = result.html;\n                                tourConfig.tourName = tourConfig.name;\n                                delete tourConfig.name;\n\n                                const tour = new BootstrapTour(tourConfig);\n                                tour.startTour(0);\n                                return;\n                            });\n                    } else {\n                        manualTourInProgress = false;\n                        alert('Error starting tour: ' + (response.message || 'Unknown error'));\n                    }\n                }).fail(function (error) {\n                    manualTourInProgress = false;\n                    window.console.error('Error starting custom tour:', error);\n                    alert('Error starting tour. Please try again.');\n                });\n            },\n            sectionClick: function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                const section = e.currentTarget;\n                currentStepObject = {\n                    targettype: '0',\n                    targetvalue: '#' + section.getAttribute('id'),\n                    placement: 'right',\n                    orphan: 'false',\n                    backdrop: 'true',\n                    reflex: 'false',\n                };\n                // Show current step indicator\n                showCurrentStepIndicator('Section: ' + section.getAttribute('data-sectionname'));\n                removeHighlighting();\n                startTextEditor();\n            },\n            moduleClick: function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                const mod = e.currentTarget;\n                currentStepObject = {\n                    targettype: '0',\n                    targetvalue: '#' + mod.getAttribute('id'),\n                    placement: 'right',\n                    orphan: 'false',\n                    backdrop: 'true',\n                    reflex: 'false',\n                };\n                // Show current step indicator\n                // check if direct child of mod has data-activityname\n                showCurrentStepIndicator('Module: ' + mod.childNodes[1].getAttribute('data-activityname'));\n\n                removeHighlighting();\n                startTextEditor();\n            }\n        };\n\n        const addStickyButton = function (element) {\n            if (element.classList.contains('section-sticky-highlight')) {\n                element.classList.add('section-sticky-button-temp');\n                Str.get_string('selectplacement', 'block_teacher_tours').then(function (text) {\n                    element.html(text);\n                });\n            } else if (element.classList.contains('header-sticky-highlight')) {\n                element.classList.add('header-sticky-button-temp');\n                Str.get_string('selectplacement', 'block_teacher_tours').then(function (text) {\n                    element.html(text);\n                });\n            }\n        };\n\n        const removeStickyButton = function () {\n            document.querySelectorAll('.section-sticky-button-temp').forEach(element => {\n                element.classList.remove('section-sticky-button-temp');\n            });\n            document.querySelectorAll('.header-sticky-button-temp').forEach(element => {\n                element.classList.remove('header-sticky-button-temp');\n            });\n        };\n\n        // Highlight the elements\n        const highlightElements = function () {\n            // Highlight the sections in light green\n            // Highlight the mods in blue\n            document.querySelectorAll('[id^=\"section-\"]').forEach(section => {\n                section.classList.add('section-highlight');\n                section.addEventListener('click', tourEventHandlers.sectionClick);\n            });\n            document.querySelectorAll('[id^=\"module-\"]').forEach(mod => {\n                mod.classList.add('module-highlight');\n                mod.addEventListener('click', tourEventHandlers.moduleClick);\n            });\n        };\n\n        const setPlacements = function (placementid, customtourid) {\n            Str.get_string('touravailable', 'block_teacher_tours').then(function (text) {\n                if (placementid.startsWith('section-')) {\n                    document.querySelectorAll('[id=\"' + placementid + '\"]').forEach(section => {\n                        const button = document.createElement('button');\n                        button.dataset.customtourid = customtourid;\n                        button.className = 'btn btn-sm btn-outline-primary section-sticky-button';\n                        button.textContent = text + ' ';\n                        const icon = document.createElement('i');\n                        icon.className = 'fa fa-question-circle';\n                        button.append(icon);\n                        section.style.position = 'relative';\n                        section.prepend(button);\n                        button.addEventListener('click', tourEventHandlers.stickyStartClick);\n                    });\n                } else if (placementid === 'page-header') {\n                    document.querySelectorAll('[id=\"page-header\"]').forEach(header => {\n                        const button = document.createElement('button');\n                        button.dataset.customtourid = customtourid;\n                        button.className = 'btn btn-sm btn-outline-primary header-sticky-button';\n                        button.textContent = text + ' ';\n                        const icon = document.createElement('i');\n                        icon.className = 'fa fa-question-circle';\n                        button.append(icon);\n                        header.style.position = 'relative';\n                        header.prepend(button);\n                        button.addEventListener('click', tourEventHandlers.stickyStartClick);\n                    });\n                }\n            });\n        };\n\n        // Highlight the elements\n        const highlightPlacements = function () {\n            // TODO consider case of multiple tours on one element\n            // \"Highlight\" the section placements and the course header placement\n            // onclick remove pseudo elements and handle click in differenct function\n            Str.get_string('selectplacement', 'block_teacher_tours').then(function (text) {\n                document.querySelectorAll('[id^=\"section-\"]').forEach(section => {\n                    const button = document.createElement('button');\n                    button.className = 'btn btn-sm btn-outline-primary section-sticky-highlight';\n                    button.textContent = text + ' ';\n                    const icon = document.createElement('i');\n                    icon.className = 'fa fa-question-circle';\n                    button.append(icon);\n                    section.style.position = 'relative';\n                    section.prepend(button);\n                    button.addEventListener('click', tourEventHandlers.stickySelectClick);\n                });\n                document.querySelectorAll('[id=\"page-header\"]').forEach(mod => {\n                    const button = document.createElement('button');\n                    button.className = 'btn btn-sm btn-outline-primary header-sticky-highlight';\n                    button.textContent = text + ' ';\n                    const icon = document.createElement('i');\n                    icon.className = 'fa fa-question-circle';\n                    button.append(icon);\n                    mod.style.position = 'relative';\n                    mod.prepend(button);\n                    button.addEventListener('click', tourEventHandlers.stickySelectClick);\n                });\n            });\n        };\n\n        // The second step on creating a step for the tour is creating a text that should show when the step is active\n        const startTextEditor = function (editIndex = null) {\n            $('#text-editor').show();\n            if (editIndex === null) {\n                clearTextEditor();\n            }\n            $('#save-tour').hide();\n            $('#step-title').focus();\n\n            // Store edit index for later use\n            $('#text-editor').data('edit-index', editIndex);\n        };\n\n        const clearTextEditor = function () {\n            $('#step-title').val('');\n            $('#step-content').val('');\n            // $('#step-placement').val('right');\n            // $('#step-backdrop').prop('checked', true);\n            // $('#step-orphan').prop('checked', false);\n            // $('#step-reflex').prop('checked', false);\n        };\n\n        const removeHighlighting = function () {\n            if (sticky) {\n                document.querySelectorAll('.section-sticky-highlight:not(.section-sticky-button-temp)').forEach(section => {\n                    section.remove();\n                });\n                document.querySelectorAll('.header-sticky-highlight:not(.header-sticky-button-temp)').forEach(mod => {\n                    mod.remove();\n                });\n            } else {\n                // Remove the highlighting from the elements and their specific event listeners\n                document.querySelectorAll('[id^=\"section-\"]').forEach(section => {\n                    section.classList.remove('section-highlight');\n                    section.removeEventListener('click', tourEventHandlers.sectionClick);\n                });\n                document.querySelectorAll('[id^=\"module-\"]').forEach(mod => {\n                    mod.classList.remove('module-highlight');\n                    mod.removeEventListener('click', tourEventHandlers.moduleClick);\n                });\n            }\n        };\n\n        // Send the tourObject to the endpoint\n        const saveTour = function () {\n            $('#save-tour').prop('disabled', true).text('Saving...');\n            // Send the tourObject to the endpoint\n            let argsObj = {};\n            if (stickyTarget) {\n                tourObject.placementid = stickyTarget;\n                tourObject.custom = true;\n                argsObj = { tour: tourObject };\n            } else {\n                tourObject.custom = false;\n                argsObj = { tour: tourObject };\n            }\n            Ajax.call([{\n                methodname: 'block_teacher_tours_save_tour',\n                args: argsObj,\n            }])[0].then(function (response) {\n                //If ok reset the tourObject, if not show error\n                if (!response && !response.status === 'ok') {\n                    alert('Error saving tour: ' + (response.message || 'Unknown error'));\n                }\n                resetTourObject();\n\n                $('#tour-editor').hide();\n                $('#start-tour-creation').show();\n                $('#start-sticky-creation').show();\n                $('#step-creation').show();\n                hideCurrentStepIndicator();\n                clearTextEditor();\n                removeHighlighting();\n                $('.tour-preview').html('');\n                $('.tour-preview').hide();\n                Str.get_string('savetour', 'block_teacher_tours')\n                    .then(function (text) {\n                        $('#save-tour').prop('disabled', false).html('<i class=\"fa fa-save\"></i> ' + text);\n                    });\n            });\n        };\n\n        // Reset the tourObject\n        const resetTourObject = function (courseid) {\n            stickyTarget = null;\n            sticky = false;\n\n            tourObject = {\n                steps: [],\n                name: 'tour for course ' + courseid,\n                description: 'A tour for course ' + courseid,\n                pathmatch: '/course/view.php?id=' + courseid,\n                enabled: '',\n                filter_values: '',\n                sortorder: '',\n            };\n        };\n\n        // Add a step to the tourObject\n        const addStep = function (stepData) {\n            tourObject.steps.push(stepData || {});\n        };\n\n        // Edit an existing step\n        const editStep = function (stepIndex) {\n            if (stepIndex < tourObject.steps.length) {\n                const step = tourObject.steps[stepIndex];\n\n                // Populate the form with existing step data\n                $('#step-title').val(step.title);\n                $('#step-content').val(step.content);\n\n                // Show the text editor with edit mode\n                startTextEditor(stepIndex);\n\n                // Hide tour save button while editing\n                $('#save-tour').hide();\n\n                // Update current step object for any placement changes\n                currentStepObject = {\n                    targettype: step.targettype,\n                    targetvalue: step.targetvalue,\n                    placement: step.placement,\n                    orphan: step.orphan,\n                    backdrop: step.backdrop,\n                    reflex: step.reflex\n                };\n\n                // Show current step indicator\n                showCurrentStepIndicator('Editing: ' + step.targetvalue);\n            }\n        };\n\n        // Save the current step to the tour object\n        const saveStep = function () {\n            // Get values from the form\n            const title = $('#step-title').val();\n            const content = $('#step-content').val();\n            // TODO maybe\n            // const placement = $('#step-placement').val();\n            // const backdrop = $('#step-backdrop').prop('checked') ? 'true' : 'false';\n            // const orphan = $('#step-orphan').prop('checked') ? 'true' : 'false';\n            // const reflex = $('#step-reflex').prop('checked') ? 'true' : 'false';\n\n            // Check if we're editing an existing step\n            const editIndex = $('#text-editor').data('edit-index');\n\n            if (editIndex !== null && editIndex !== undefined) {\n                // Update existing step\n                tourObject.steps[editIndex].title = title;\n                tourObject.steps[editIndex].content = content;\n                showTourStepsPreview();\n                clearTextEditor();\n                $('#text-editor').hide();\n                $('#save-tour').show();\n                $('#text-editor').data('edit-index', null);\n            } else {\n                // Update the current step object with form values\n                currentStepObject.title = title;\n                currentStepObject.content = content;\n                // currentStepObject.placement = placement;\n                // currentStepObject.backdrop = backdrop;\n                // currentStepObject.orphan = orphan;\n                // currentStepObject.reflex = reflex;\n\n                // Add the step to the tour\n                addStep(currentStepObject);\n            }\n        };\n\n        // Initialize event bindings\n        const initializeEventBindings = function () {\n            // Bind click event to start tour creation button\n            $(document).on('click', '#start-tour-creation', function (e) {\n                e.preventDefault();\n                startEditor();\n            });\n\n            $(document).on('click', '#start-sticky-creation', function (e) {\n                e.preventDefault();\n                sticky = true;\n                startEditor();\n            });\n\n\n            // Bind click event to save tour button\n            $(document).on('click', '#save-tour', function (e) {\n                e.preventDefault();\n                saveTour();\n            });\n\n            // Bind click event to save step button\n            $(document).on('click', '#save-step', function (e) {\n                e.preventDefault();\n                saveStep();\n                // Hide the text editor\n                $('#text-editor').hide();\n                $('#save-tour').show();\n                // Reset for next step\n                showTourStepsPreview();\n                hideCurrentStepIndicator();\n                resetCurrentStepObject();\n                // Restart the editor to pick the next element\n                startEditor();\n            });\n\n            // Bind click event to edit step icon\n            $(document).on('click', '.edit-step-icon', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                const stepIndex = $(this).parent().data('step-index');\n                editStep(stepIndex);\n            });\n\n            // Bind click event to cancel step edit button\n            $(document).on('click', '#cancel-step-edit', function (e) {\n                e.preventDefault();\n                hideCurrentStepIndicator();\n                resetCurrentStepObject();\n                $('#text-editor').hide();\n                startEditor();\n            });\n\n            // Bind click event to cancel tour creation button\n            $(document).on('click', '#cancel-tour-creation', function (e) {\n                e.preventDefault();\n                $('#tour-editor').hide();\n                $('#start-sticky-creation').show();\n                $('#start-tour-creation').show();\n                hideCurrentStepIndicator();\n                removeHighlighting();\n                removeStickyButton();\n                resetTourObject();\n                $('.tour-preview').html('');\n                $('.tour-preview').hide();\n            });\n\n            $(document).on('click', '#step-creation', function () {\n                startEditor();\n            });\n\n            // Bind events for tour management\n            $(document).on('change', '.tour-toggle', function () {\n                const tourId = $(this).data('tour-id');\n                const tourType = $(this).data('tour-type') || 'standard';\n                const enabled = $(this).is(':checked');\n                handleTourToggle(tourId, enabled, tourType);\n            });\n\n            $(document).on('click', '.edit-tour', function (e) {\n                e.preventDefault();\n                const tourId = $(this).data('tour-id');\n                const tourType = $(this).data('tour-type') || 'standard';\n                handleTourEdit(tourId, tourType);\n            });\n\n            $(document).on('click', '.delete-tour', function (e) {\n                e.preventDefault();\n                const tourId = $(this).data('tour-id');\n                const tourType = $(this).data('tour-type') || 'standard';\n                handleTourDelete(tourId, tourType);\n            });\n        };\n\n        // Return public API\n        return {\n            sticky: sticky,\n            currentStepObject: currentStepObject,\n            tourObject: tourObject,\n            tourQueue: tourQueue,\n            shownTourIds: shownTourIds,\n            init: init,\n            startEditor: startEditor,\n            resetTourObject: resetTourObject,\n            addStep: addStep,\n            saveStep: saveStep,\n            saveTour: saveTour,\n            startTextEditor: startTextEditor,\n            highlightElements: highlightElements,\n            initializeEventBindings: initializeEventBindings,\n            initTourQueue: initTourQueue,\n            startNextTour: startNextTour,\n            setupTourEndedListener: setupTourEndedListener\n        };\n    }\n);\n"],"names":["define","$","Ajax","Str","UserTourEvents","tourRepository","Templates","BootstrapTour","tourObject","steps","name","description","pathmatch","enabled","filter_values","sortorder","stickyTarget","sticky","currentStepObject","tourQueue","currentTourIndex","shownTourIds","currentCourseId","tourEndedListenerAdded","manualTourInProgress","initTourQueue","courseid","call","methodname","args","shownids","JSON","stringify","done","tours","fail","error","window","console","setupTourEndedListener","document","addEventListener","eventTypes","tourEnded","handleTourEnded","e","_e$detail","endedTour","detail","tour","endedTourId","tourId","id","config","originalConfig","custom_tour_id","push","setTimeout","startNextTour","length","nextTour","tourKey","type","includes","startCustomTourFromQueue","startStandardTourFromQueue","fetchTour","then","response","hasOwnProperty","renderForPromise","tourconfig","result","startTourWithConfig","html","warn","catch","template","tourConfig","tourName","map","step","element","target","reflex","moveOnClick","content","body","startTour","customTourId","customtourid","success","tourid","message","startEditor","hide","show","highlightPlacements","highlightElements","showCurrentStepIndicator","elementText","text","showTourStepsPreview","forEach","index","append","targetvalue","title","hideCurrentStepIndicator","resetCurrentStepObject","hexToRgba","hex","opacity","replace","parseInt","substring","init_styles","colors","teachertoursColors","style","createElement","moduleHighlightopacity03","moduleHighlight","moduleHighlightopacity05","sectionHighlightopacity03","sectionHighlight","sectionHighlightopacity05","textContent","head","appendChild","tourEventHandlers","preventDefault","stopPropagation","currentTarget","addStickyButton","parent","parentElement","getAttribute","removeHighlighting","dataset","parse","alert","section","targettype","placement","orphan","backdrop","startTextEditor","mod","childNodes","classList","contains","add","get_string","querySelectorAll","setPlacements","placementid","startsWith","button","className","icon","position","prepend","header","editIndex","arguments","undefined","clearTextEditor","focus","data","val","remove","removeEventListener","saveTour","prop","argsObj","custom","status","resetTourObject","addStep","stepData","saveStep","initializeEventBindings","on","stepIndex","editStep","this","tourType","tourCard","statusElement","find","enabledText","disabledText","handleTourToggle","is","handleTourEdit","confirm","fadeOut","handleTourDelete","init","customTours","Object","values"],"mappings":"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"}